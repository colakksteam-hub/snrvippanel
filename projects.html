<script type="module">
  import { requireAuth } from "./guard.js";
  import { db } from "./firebase.js";
  import {
    collection, getDocs, addDoc, updateDoc, deleteDoc, doc,
    query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  requireAuth();

  const colRef = collection(db, "projects");

  const addBtn = document.getElementById("addBtn");
  const listEl =
    document.getElementById("list") ||
    document.getElementById("projectsList") ||
    document.querySelector(".list");

  let projects = [];
  let addRowOpen = false;

  function escapeHtml(s=""){
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function rowTemplate(p){
    return `
      <div class="row">
        <div class="cell"><b>${escapeHtml(p.name)}</b></div>
        <div class="cell">${escapeHtml(p.type || "-")}</div>
        <div class="cell">${escapeHtml(p.location || "-")}</div>
        <div class="cell">${escapeHtml(p.client || "-")}</div>
        <div class="cell">
          <span class="badge ${p.isActive ? "green":"gray"}">
            ${p.isActive ? "Aktif":"Pasif"}
          </span>
        </div>
        <div class="cell actions">
          <button class="btn small edit" data-id="${p.id}">Düzenle</button>
          <button class="btn small danger del" data-id="${p.id}">Sil</button>
        </div>
      </div>
    `;
  }

  function addRowTemplate(){
    return `
    <div class="row new-row" id="newRow">
      <div class="cell">
        <input id="pName" placeholder="Proje adı" />
      </div>
      <div class="cell">
        <select id="pType">
          <option value="">Tür seç</option>
          <option value="fabrika">Fabrika</option>
          <option value="santiye">Şantiye</option>
          <option value="site">Site</option>
          <option value="vip">VIP</option>
        </select>
      </div>
      <div class="cell">
        <input id="pLocation" placeholder="Lokasyon" />
      </div>
      <div class="cell">
        <input id="pClient" placeholder="Müşteri (ops.)" />
      </div>
      <div class="cell">
        <select id="pActive">
          <option value="true">Aktif</option>
          <option value="false">Pasif</option>
        </select>
      </div>
      <div class="cell actions">
        <button class="btn small primary" id="saveBtn">Kaydet</button>
        <button class="btn small" id="cancelBtn">İptal</button>
      </div>
    </div>`;
  }

  function render(){
    if(!listEl) return;

    listEl.innerHTML = `
      ${addRowOpen ? addRowTemplate() : ""}
      ${projects.map(rowTemplate).join("")}
    `;

    if(addRowOpen){
      document.getElementById("saveBtn").onclick = saveNew;
      document.getElementById("cancelBtn").onclick = closeAddRow;
    }

    listEl.querySelectorAll(".del").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.id;
        if(confirm("Projeyi silmek istiyor musun?")){
          await deleteDoc(doc(db,"projects",id));
          await load();
        }
      };
    });

    listEl.querySelectorAll(".edit").forEach(btn=>{
      btn.onclick = ()=> openEdit(btn.dataset.id);
    });
  }

  function openAddRow(){
    addRowOpen = true;
    render();
  }

  function closeAddRow(){
    addRowOpen = false;
    render();
  }

  async function saveNew(){
    const nameEl = document.getElementById("pName");
    const typeEl = document.getElementById("pType");
    const locEl  = document.getElementById("pLocation");
    const cliEl  = document.getElementById("pClient");
    const actEl  = document.getElementById("pActive");

    const name = (nameEl?.value || "").trim();
    const type = (typeEl?.value || "").trim();
    const location = (locEl?.value || "").trim();
    const client = (cliEl?.value || "").trim();
    const isActive = (actEl?.value || "true") === "true";

    if(!name){
      alert("Proje adı boş olamaz");
      return;
    }

    await addDoc(colRef, {
      name, type, location, client,
      isActive,
      createdAt: new Date()
    });

    addRowOpen = false;
    await load();
  }

  function openEdit(id){
    const p = projects.find(x=>x.id===id);
    if(!p) return;

    const row = document.createElement("div");
    row.className = "row edit-row";
    row.innerHTML = `
      <div class="cell"><input id="eName" value="${escapeHtml(p.name)}"/></div>
      <div class="cell">
        <select id="eType">
          <option value="">Tür seç</option>
          <option value="fabrika" ${p.type==="fabrika"?"selected":""}>Fabrika</option>
          <option value="santiye" ${p.type==="santiye"?"selected":""}>Şantiye</option>
          <option value="site" ${p.type==="site"?"selected":""}>Site</option>
          <option value="vip" ${p.type==="vip"?"selected":""}>VIP</option>
        </select>
      </div>
      <div class="cell"><input id="eLocation" value="${escapeHtml(p.location||"")}"/></div>
      <div class="cell"><input id="eClient" value="${escapeHtml(p.client||"")}"/></div>
      <div class="cell">
        <select id="eActive">
          <option value="true" ${p.isActive?"selected":""}>Aktif</option>
          <option value="false" ${!p.isActive?"selected":""}>Pasif</option>
        </select>
      </div>
      <div class="cell actions">
        <button class="btn small primary" id="updateBtn">Güncelle</button>
        <button class="btn small" id="cancelEditBtn">İptal</button>
      </div>
    `;

    // listeyi yeniden çizip en üste edit formunu koy
    addRowOpen = false;
    listEl.innerHTML = row.outerHTML + projects.filter(x=>x.id!==id).map(rowTemplate).join("");

    document.getElementById("updateBtn").onclick = async ()=>{
      const name = document.getElementById("eName").value.trim();
      const type = document.getElementById("eType").value.trim();
      const location = document.getElementById("eLocation").value.trim();
      const client = document.getElementById("eClient").value.trim();
      const isActive = document.getElementById("eActive").value === "true";
      if(!name){ alert("Proje adı boş olamaz"); return; }

      await updateDoc(doc(db,"projects",id), {
        name, type, location, client, isActive
      });
      await load();
    };

    document.getElementById("cancelEditBtn").onclick = render;
  }

  async function load(){
    const snap = await getDocs(query(colRef, orderBy("createdAt","desc")));
    projects = snap.docs.map(d=>({id:d.id, ...d.data()}));
    render();
  }

  addBtn.onclick = openAddRow;
  load();
</script>

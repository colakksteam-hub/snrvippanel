<script type="module">
  /*********** Firebase importları (v9 modüler) ***********/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, getDocs, addDoc, doc,
    updateDoc, deleteDoc, serverTimestamp, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  /*********** Firebase Config (BURAYI DOLDUR) ***********/
  const firebaseConfig = {
  apiKey: "AIzaSyAHZTI1E_WLe6qfAXu2uWUOx91YfHfarMgk",
  authDomain: "snrvippanel.firebaseapp.com",
  projectId: "snrvippanel",
  storageBucket: "snrvippanel.appspot.com",
  messagingSenderId: "1081915628150",
  appId: "1:1081915628150:web:10b95399cd21687c5ddd57",
  measurementId: "G-Q9KZ9E1CZD"
};

  /*********** Firebase init ***********/
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  /*********** Koleksiyon ***********/
  const colProjects = collection(db, "projects"); // <-- koleksiyon adın farklıysa değiştir

  /*********** DOM Elementleri ***********/
  const projectList = document.getElementById("projectList");
  const formCard = document.getElementById("formCard");
  const formTitle = document.getElementById("formTitle");

  const addBtn = document.getElementById("addBtn");
  const saveBtn = document.getElementById("saveBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  const searchInput = document.getElementById("searchInput");
  const filterType = document.getElementById("filterType");

  // INPUT ELEMENTLERİ (asla .value ile yukarıda stringe çevirme!)
  const nameInput     = document.getElementById("name");
  const typeInput     = document.getElementById("type");
  const locationInput = document.getElementById("location");
  const clientInput   = document.getElementById("client");
  const isActiveInput = document.getElementById("isActive");

  let editingId = null;
  let allProjects = [];

  /*********** Kullanıcı email göster ***********/
  onAuthStateChanged(auth, (user) => {
    const pill = document.getElementById("userEmail");
    if (pill) pill.textContent = user?.email || "Misafir";
  });

  /*********** Firestore yardımcıları ***********/
  async function addWithTS(colRef, data) {
    return addDoc(colRef, { ...data, createdAt: serverTimestamp() });
  }

  async function updateById(colRef, id, data) {
    const ref = doc(colRef, id);
    return updateDoc(ref, data);
  }

  async function deleteById(colRef, id) {
    const ref = doc(colRef, id);
    return deleteDoc(ref);
  }

  /*********** Listeyi yükle ***********/
  async function load() {
    projectList.innerHTML = "Yükleniyor...";
    const q = query(colProjects, orderBy("createdAt", "desc"));
    const snap = await getDocs(q);

    allProjects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    render();
  }

  /*********** HTML güvenliği ***********/
  function escapeHtml(str) {
    return String(str ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
    }[m]));
  }

  /*********** Listeyi çiz (arama + filtre) ***********/
  function render() {
    const s = searchInput.value.toLowerCase().trim();
    const ft = filterType.value;

    const filtered = allProjects.filter(p => {
      const matchSearch =
        (p.name || "").toLowerCase().includes(s) ||
        (p.location || "").toLowerCase().includes(s) ||
        (p.client || "").toLowerCase().includes(s);

      const matchType = ft === "all" ? true : p.type === ft;
      return matchSearch && matchType;
    });

    if (filtered.length === 0) {
      projectList.innerHTML = `<div class="row"><div>Sonuç yok</div></div>`;
      return;
    }

    projectList.innerHTML = filtered.map(p => `
      <div class="row">
        <div><b>${escapeHtml(p.name)}</b></div>
        <div>${escapeHtml(p.type)}</div>
        <div>${escapeHtml(p.location)}</div>
        <div>
          <span class="badge ${p.isActive ? "" : "passive"}">
            ${p.isActive ? "Aktif" : "Pasif"}
          </span>
        </div>
        <div class="actions">
          <button class="btn ghost" data-edit="${p.id}">Düzenle</button>
          <button class="btn red" data-del="${p.id}">Sil</button>
        </div>
      </div>
    `).join("");

    projectList.querySelectorAll("[data-edit]").forEach(btn => {
      btn.onclick = () => openEdit(btn.dataset.edit);
    });

    projectList.querySelectorAll("[data-del]").forEach(btn => {
      btn.onclick = () => onDelete(btn.dataset.del);
    });
  }

  /*********** Yeni Proje Aç ***********/
  addBtn.onclick = () => {
    editingId = null;
    formTitle.textContent = "Yeni Proje";

    nameInput.value = "";
    typeInput.value = "fabrika";
    locationInput.value = "";
    clientInput.value = "";
    isActiveInput.value = "true";

    formCard.style.display = "block";
  };

  cancelBtn.onclick = () => {
    formCard.style.display = "none";
  };

  /*********** Kaydet ***********/
  saveBtn.onclick = async () => {
    const data = {
      name: nameInput.value.trim(),
      type: typeInput.value,
      location: locationInput.value.trim(),
      client: clientInput.value.trim(),
      isActive: isActiveInput.value === "true"
    };

    if (!data.name) return alert("Proje adı boş olamaz");

    if (editingId) {
      await updateById(colProjects, editingId, data);
    } else {
      await addWithTS(colProjects, data);
    }

    formCard.style.display = "none";
    await load();
  };

  /*********** Düzenleme Aç ***********/
  function openEdit(id) {
    const p = allProjects.find(x => x.id === id);
    if (!p) return;

    editingId = id;
    formTitle.textContent = "Projeyi Düzenle";

    nameInput.value = p.name || "";
    typeInput.value = p.type || "fabrika";
    locationInput.value = p.location || "";
    clientInput.value = p.client || "";
    isActiveInput.value = p.isActive ? "true" : "false";

    formCard.style.display = "block";
  }

  /*********** Sil ***********/
  async function onDelete(id) {
    const ok = confirm("Projeyi silmek istiyor musun?");
    if (!ok) return;

    await deleteById(colProjects, id);
    await load();
  }

  /*********** Arama/filtre ***********/
  searchInput.addEventListener("input", render);
  filterType.addEventListener("change", render);

  load();
</script>

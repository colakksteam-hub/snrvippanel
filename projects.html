<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SNR VIP | Projeler</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">SNR</div>
      <div>
        <div class="title">SNR VIP</div>
        <div class="sub">GÃ¼venlik & Koruma</div>
      </div>
    </div>
    <nav class="nav">
      <a href="dashboard.html">ğŸ  Dashboard</a>
      <a class="active" href="projects.html">ğŸ—ï¸ Proje Paneli</a>
      <a href="personnel.html">ğŸ‘® Personel</a>
      <a href="vehicles.html">ğŸš— AraÃ§ YÃ¶netimi</a>
      <a href="#" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ</a>
    </nav>
  </aside>

  <main class="main">
    <div class="topbar">
      <h1 style="margin:0;">Projeler</h1>
      <div class="user">
        <div class="pill" id="currentUser">YÃ¶netici</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <input id="q" placeholder="Proje ara (ad/lokasyon/mÃ¼ÅŸteri)"/>
      <select id="typeFilter">
        <option value="">TÃ¼mÃ¼</option>
        <option value="santiye">Åantiye</option>
        <option value="fabrika">Fabrika</option>
        <option value="plaza">Plaza</option>
        <option value="diger">DiÄŸer</option>
      </select>
      <select id="statusFilter">
        <option value="">TÃ¼m Durumlar</option>
        <option value="aktif">Aktif</option>
        <option value="pasif">Pasif</option>
      </select>
      <button id="addBtn">+ Proje Ekle</button>
    </div>

    <!-- Liste -->
    <div id="projectsList"></div>

    <!-- Form -->
    <div id="formCard" class="card" style="display:none; margin-top:16px;">
      <h2 id="formTitle" style="margin-top:0;">Yeni Proje</h2>
      <div class="toolbar" style="flex-wrap:wrap; gap:8px;">
        <input id="pName" placeholder="Proje AdÄ±"/>
        <select id="pType">
          <option value="santiye">Åantiye</option>
          <option value="fabrika">Fabrika</option>
          <option value="plaza">Plaza</option>
          <option value="diger">DiÄŸer</option>
        </select>
        <input id="pLocation" placeholder="Lokasyon"/>
        <input id="pClient" placeholder="MÃ¼ÅŸteri (ops.)"/>
        <select id="pStatus">
          <option value="aktif">Aktif</option>
          <option value="pasif">Pasif</option>
        </select>
        <button id="saveBtn">Kaydet</button>
        <button class="secondary" id="cancelBtn">Ä°ptal</button>
      </div>
    </div>

  </main>
</div>

<script type="module">
  import { requireAuth } from "./guard.js";
  import { db } from "./firebase.js";
  import {
    collection, getDocs, addDoc, updateDoc, deleteDoc, doc,
    query, orderBy, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  requireAuth();

  // ---- DOM ----
  const qInput = document.getElementById("q");
  const typeFilter = document.getElementById("typeFilter");
  const statusFilter = document.getElementById("statusFilter");
  const addBtn = document.getElementById("addBtn");
  const listEl = document.getElementById("projectsList");

  const formCard = document.getElementById("formCard");
  const formTitle = document.getElementById("formTitle");
  const pName = document.getElementById("pName");
  const pType = document.getElementById("pType");
  const pLocation = document.getElementById("pLocation");
  const pClient = document.getElementById("pClient");
  const pStatus = document.getElementById("pStatus");
  const saveBtn = document.getElementById("saveBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  // ---- Firestore ----
  const projectsRef = collection(db, "projects");

  let projects = [];
  let editingId = null;

  const escapeHtml = (s="") =>
    s.toString().replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));

  function rowTemplate(p){
    return `
      <div class="card row" style="display:grid; grid-template-columns: 2fr 1fr 2fr 1fr auto; gap:8px; align-items:center;">
        <div>
          <div style="font-weight:700;">${escapeHtml(p.name)}</div>
          <div style="opacity:.7; font-size:13px;">${escapeHtml(p.client || "-")}</div>
        </div>
        <div>${escapeHtml(p.type || "-")}</div>
        <div>${escapeHtml(p.location || "-")}</div>
        <div>
          <span class="badge ${p.status==="aktif"?"green":"gray"}">
            ${escapeHtml(p.status || "-")}
          </span>
        </div>
        <div style="display:flex; gap:6px;">
          <button class="btn small edit" data-id="${p.id}">DÃ¼zenle</button>
          <button class="btn small danger del" data-id="${p.id}">Sil</button>
        </div>
      </div>
    `;
  }

  function filtered(){
    const q = (qInput.value || "").toLowerCase().trim();
    const t = typeFilter.value || "";
    const s = statusFilter.value || "";

    return projects.filter(p=>{
      const hay = `${p.name||""} ${p.location||""} ${p.client||""}`.toLowerCase();
      const matchesQ = !q || hay.includes(q);
      const matchesT = !t || p.type === t;
      const matchesS = !s || p.status === s;
      return matchesQ && matchesT && matchesS;
    });
  }

  function render(){
    const arr = filtered();
    listEl.innerHTML = arr.length
      ? arr.map(rowTemplate).join("")
      : `<div class="card" style="opacity:.7;">Proje bulunamadÄ±</div>`;

    // sil
    listEl.querySelectorAll(".del").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.id;
        if(confirm("Projeyi silmek istiyor musun?")){
          await deleteDoc(doc(db,"projects",id));
          await load();
        }
      };
    });

    // dÃ¼zenle
    listEl.querySelectorAll(".edit").forEach(btn=>{
      btn.onclick = ()=> openEdit(btn.dataset.id);
    });
  }

  function openForm(isEdit=false){
    formCard.style.display = "block";
    formTitle.textContent = isEdit ? "Proje DÃ¼zenle" : "Yeni Proje";
  }
  function closeForm(){
    formCard.style.display = "none";
    editingId = null;
    pName.value = "";
    pType.value = "santiye";
    pLocation.value = "";
    pClient.value = "";
    pStatus.value = "aktif";
  }

  function openEdit(id){
    const p = projects.find(x=>x.id===id);
    if(!p) return;
    editingId = id;

    pName.value = p.name || "";
    pType.value = p.type || "santiye";
    pLocation.value = p.location || "";
    pClient.value = p.client || "";
    pStatus.value = p.status || "aktif";

    openForm(true);
    window.scrollTo({top: document.body.scrollHeight, behavior:"smooth"});
  }

  async function save(){
    const name = pName.value.trim();
    const type = pType.value;
    const location = pLocation.value.trim();
    const client = pClient.value.trim();
    const status = pStatus.value;

    if(!name){ alert("Proje adÄ± boÅŸ olamaz"); return; }

    const payload = {
      name, type, location, client, status
    };

    if(editingId){
      await updateDoc(doc(db,"projects",editingId), payload);
    }else{
      await addDoc(projectsRef, {
        ...payload,
        createdAt: serverTimestamp()
      });
    }

    closeForm();
    await load();
  }

  async function load(){
    const snap = await getDocs(query(projectsRef, orderBy("createdAt","desc")));
    projects = snap.docs.map(d=>({id:d.id, ...d.data()}));
    render();
  }

  // ---- events ----
  addBtn.onclick = ()=> {
    editingId = null;
    openForm(false);
    window.scrollTo({top: document.body.scrollHeight, behavior:"smooth"});
  };

  saveBtn.onclick = save;
  cancelBtn.onclick = closeForm;

  [qInput, typeFilter, statusFilter].forEach(el=>{
    el.addEventListener("input", render);
    el.addEventListener("change", render);
  });

  window.addEventListener("DOMContentLoaded", load);
</script>
</body>
</html>

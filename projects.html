<!DOCTYPE html><html lang="tr"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SNR VIP | Projeler</title><link rel="stylesheet" href="styles.css"/></head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand"><div class="logo">SNR</div><div><div class="title">SNR VIP</div><div class="sub">GÃ¼venlik & Koruma</div></div></div>
    <nav class="nav">
      <a href="dashboard.html">ğŸ  Dashboard</a>
      <a class="active" href="projects.html">ğŸ—ï¸ Proje Paneli</a>
      <a href="personnel.html">ğŸ‘® Personel</a>
      <a href="vehicles.html">ğŸš— AraÃ§ YÃ¶netimi</a>
      <a href="#" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ</a>
    </nav>
  </aside>
  <main class="main">
    <div class="topbar"><h1 style="margin:0;">Projeler</h1><div class="user"><div class="pill" id="currentUser">YÃ¶netici</div></div></div>
    <div class="toolbar">
      <input id="q" placeholder="Proje ara"/>
      <select id="typeFilter">
        <option value="">TÃ¼mÃ¼</option><option value="fabrika">Fabrika</option><option value="ÅŸantiye">Åantiye</option>
        <option value="site">Site</option><option value="vip">VIP</option>
      </select>
      <button id="addBtn">+ Proje Ekle</button>
    </div>
    <table><thead><tr><th>Proje</th><th>TÃ¼r</th><th>Lokasyon</th><th>Durum</th><th></th></tr></thead>
      <tbody id="tbody"></tbody></table>

    <div id="formCard" class="card" style="display:none;">
      <h2 id="formTitle">Yeni Proje</h2>
      <div class="toolbar">
        <input id="name" placeholder="Proje adÄ±"/>
        <select id="type"><option value="fabrika">Fabrika</option><option value="ÅŸantiye">Åantiye</option><option value="site">Site</option><option value="vip">VIP</option></select>
        <input id="location" placeholder="Lokasyon"/><input id="client" placeholder="MÃ¼ÅŸteri (ops.)"/>
        <select id="isActive"><option value="true">Aktif</option><option value="false">Pasif</option></select>
        <button id="saveBtn">Kaydet</button><button class="secondary" id="cancelBtn">Ä°ptal</button>
      </div>
    </div>
  </main>
</div>

<script type="module">
import { requireAuth } from "./guard.js";
import { listCol, addWithTS, updateById, deleteById, colProjects } from "./db.js";

requireAuth();
let projects=[], editingId=null;

async function load(){
  projects = await listCol(colProjects);
  projects.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  render();
}
function render(){
  const text=q.value.toLowerCase();
  const tf=typeFilter.value;
  const filtered = projects.filter(p=>{
    const mt=(p.name||"").toLowerCase().includes(text)||
             (p.type||"").toLowerCase().includes(text)||
             (p.location||"").toLowerCase().includes(text);
    const mty=!tf || p.type===tf;
    return mt && mty;
  });
  tbody.innerHTML = filtered.map(p=>`
    <tr>
      <td><b>${p.name}</b></td><td>${p.type||"-"}</td><td>${p.location||"-"}</td>
      <td>${p.isActive?'<span class="badge green">Aktif</span>':'<span class="badge">Pasif</span>'}</td>
      <td style="text-align:right;">
        <button class="secondary" data-edit="${p.id}">DÃ¼zenle</button>
        <button class="secondary" data-del="${p.id}">Sil</button>
      </td>
    </tr>`).join("");

  tbody.querySelectorAll("[data-edit]").forEach(b=>b.onclick=()=>edit(b.dataset.edit));
  tbody.querySelectorAll("[data-del]").forEach(b=>b.onclick=()=>del(b.dataset.del));
}
function edit(id){
  const p=projects.find(x=>x.id===id);
  editingId=id; formCard.style.display="block"; formTitle.textContent="Proje DÃ¼zenle";
  name.value=p.name||""; type.value=p.type||"fabrika"; location.value=p.location||"";
  client.value=p.client||""; isActive.value=String(!!p.isActive);
}
async function del(id){
  if(confirm("Projeyi silmek istiyor musun?")){
    await deleteById(colProjects,id); await load();
  }
}

addBtn.onclick=()=>{ editingId=null; formCard.style.display="block"; formTitle.textContent="Yeni Proje";
  name.value=""; type.value="fabrika"; location.value=""; client.value=""; isActive.value="true"; };
cancelBtn.onclick=()=>formCard.style.display="none";
saveBtn.onclick=async ()=>{
  const data={name:name.value.trim(), type:type.value, location:location.value.trim(),
              client:client.value.trim(), isActive:isActive.value==="true"};
  if(!data.name) return alert("Proje adÄ± boÅŸ olamaz");
  if(editingId) await updateById(colProjects,editingId,data); else await addWithTS(colProjects,data);
  formCard.style.display="none"; await load();
};
q.oninput=render; typeFilter.onchange=render;
load();
</script>
</body></html>
console.log("addBtn:", document.getElementById("addBtn"));
console.log("saveBtn:", document.getElementById("saveBtn"));
console.log("cancelBtn:", document.getElementById("cancelBtn"));

<script type="module">
  import { requireAuth } from "./guard.js";
  import { db } from "./firebase.js";

  import {
    collection, getDocs, addDoc, updateDoc, deleteDoc, doc,
    query, orderBy, serverTimestamp, getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // ✅ Misafir giremesin
  requireAuth();

  const auth = getAuth();

  // Koleksiyon
  const projectsRef = collection(db, "projects");

  // DOM
  const projectList = document.getElementById("projectList");
  const formCard = document.getElementById("formCard");
  const formTitle = document.getElementById("formTitle");

  const addBtn = document.getElementById("addBtn");
  const saveBtn = document.getElementById("saveBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  const searchInput = document.getElementById("searchInput");
  const filterType = document.getElementById("filterType");

  const nameInput     = document.getElementById("name");
  const typeInput     = document.getElementById("type");
  const locationInput = document.getElementById("location");
  const clientInput   = document.getElementById("client");
  const isActiveInput = document.getElementById("isActive");

  let editingId = null;
  let allProjects = [];
  let currentRole = "none";

  function escapeHtml(str) {
    return String(str ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
    }[m]));
  }

  async function getRoleOfUser(uid) {
    // rules’larındaki userDoc ile aynı yer: users/{uid}
    const uref = doc(db, "users", uid);
    const snap = await getDoc(uref);
    if (!snap.exists()) return "none";
    return snap.data().role || "none";
  }

  async function load() {
    projectList.innerHTML = "Yükleniyor...";
    const q = query(projectsRef, orderBy("createdAt", "desc"));
    const snap = await getDocs(q);
    allProjects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    render();
  }

  function render() {
    const s = (searchInput.value || "").toLowerCase().trim();
    const ft = filterType.value;

    const filtered = allProjects.filter(p => {
      const matchSearch =
        (p.name || "").toLowerCase().includes(s) ||
        (p.location || "").toLowerCase().includes(s) ||
        (p.client || "").toLowerCase().includes(s);

      const matchType = ft === "all" ? true : p.type === ft;
      return matchSearch && matchType;
    });

    if (!filtered.length) {
      projectList.innerHTML = `<div class="row"><div>Sonuç yok</div></div>`;
      return;
    }

    const canEdit = (currentRole === "admin");

    projectList.innerHTML = filtered.map(p => `
      <div class="row">
        <div><b>${escapeHtml(p.name)}</b></div>
        <div>${escapeHtml(p.type)}</div>
        <div>${escapeHtml(p.location)}</div>
        <div>
          <span class="badge ${p.isActive ? "" : "passive"}">
            ${p.isActive ? "Aktif" : "Pasif"}
          </span>
        </div>
        <div class="actions">
          ${canEdit ? `<button class="btn ghost" data-edit="${p.id}">Düzenle</button>` : ``}
          ${canEdit ? `<button class="btn red" data-del="${p.id}">Sil</button>` : ``}
        </div>
      </div>
    `).join("");

    if (canEdit) {
      projectList.querySelectorAll("[data-edit]").forEach(btn => {
        btn.onclick = () => openEdit(btn.dataset.edit);
      });
      projectList.querySelectorAll("[data-del]").forEach(btn => {
        btn.onclick = () => onDelete(btn.dataset.del);
      });
    }
  }

  // Form
  addBtn.onclick = () => {
    if (currentRole !== "admin") return alert("Bu işlem için admin yetkisi gerekli.");

    editingId = null;
    formTitle.textContent = "Yeni Proje";

    nameInput.value = "";
    typeInput.value = "fabrika";
    locationInput.value = "";
    clientInput.value = "";
    isActiveInput.value = "true";

    formCard.style.display = "block";
  };

  cancelBtn.onclick = () => {
    formCard.style.display = "none";
  };

  saveBtn.onclick = async () => {
    if (currentRole !== "admin") return alert("Bu işlem için admin yetkisi gerekli.");

    const data = {
      name: (nameInput.value || "").trim(),
      type: typeInput.value,
      location: (locationInput.value || "").trim(),
      client: (clientInput.value || "").trim(),
      isActive: isActiveInput.value === "true"
    };

    if (!data.name) return alert("Proje adı boş olamaz");

    if (editingId) {
      await updateDoc(doc(db, "projects", editingId), data);
    } else {
      await addDoc(projectsRef, { ...data, createdAt: serverTimestamp() });
    }

    formCard.style.display = "none";
    await load();
  };

  function openEdit(id) {
    const p = allProjects.find(x => x.id === id);
    if (!p) return;

    editingId = id;
    formTitle.textContent = "Projeyi Düzenle";

    nameInput.value = p.name || "";
    typeInput.value = p.type || "fabrika";
    locationInput.value = p.location || "";
    clientInput.value = p.client || "";
    isActiveInput.value = p.isActive ? "true" : "false";

    formCard.style.display = "block";
  }

  async function onDelete(id) {
    if (!confirm("Projeyi silmek istiyor musun?")) return;
    await deleteDoc(doc(db, "projects", id));
    await load();
  }

  // Filtre
  searchInput.addEventListener("input", render);
  filterType.addEventListener("change", render);

  // ✅ Auth hazır olunca email + role al, sonra yükle
  onAuthStateChanged(auth, async (user) => {
    const pill = document.getElementById("userEmail");
    if (!user) return; // requireAuth zaten yönlendirmeli

    if (pill) pill.textContent = user.email;

    currentRole = await getRoleOfUser(user.uid);

    // admin değilse proje ekleme butonunu gizle (sadece okuyabilir)
    if (currentRole !== "admin") {
      addBtn.style.display = "none";
    }

    await load();
  });
</script>

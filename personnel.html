<!DOCTYPE html><html lang="tr"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SNR VIP | Personel</title><link rel="stylesheet" href="styles.css"/></head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand"><div class="logo">SNR</div><div><div class="title">SNR VIP</div><div class="sub">GÃ¼venlik & Koruma</div></div></div>
    <nav class="nav">
      <a href="dashboard.html">ğŸ  Dashboard</a><a href="projects.html">ğŸ—ï¸ Proje Paneli</a>
      <a class="active" href="personnel.html">ğŸ‘® Personel</a><a href="vehicles.html">ğŸš— AraÃ§ YÃ¶netimi</a>
      <a href="#" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ</a>
    </nav>
  </aside>
  <main class="main">
    <div class="topbar"><h1 style="margin:0;">Personel</h1><div class="user"><div class="pill" id="currentUser">YÃ¶netici</div></div></div>
    <div class="toolbar">
      <input id="q" placeholder="Personel ara"/>
      <select id="projectFilter"></select>
      <select id="statusFilter"><option value="">TÃ¼m Durumlar</option><option value="aktif">Aktif</option><option value="izinli">Ä°zinli</option><option value="ayrÄ±ldÄ±">AyrÄ±ldÄ±</option></select>
      <button id="addBtn">+ Personel Ekle</button>
    </div>
    <table><thead><tr><th>Ad Soyad</th><th>Unvan</th><th>Proje</th><th>Durum</th><th>Ä°ÅŸe GiriÅŸ</th><th></th></tr></thead>
      <tbody id="tbody"></tbody></table>

    <div id="formCard" class="card" style="display:none;">
      <h2 id="formTitle">Yeni Personel</h2>
      <div class="toolbar">
        <input id="fullName" placeholder="Ad soyad"/><input id="title" placeholder="Unvan"/>
        <select id="projectId"></select>
        <select id="status"><option value="aktif">Aktif</option><option value="izinli">Ä°zinli</option><option value="ayrÄ±ldÄ±">AyrÄ±ldÄ±</option></select>
        <input id="startDate" type="date"/><input id="phone" placeholder="Telefon (ops.)"/>
        <button id="saveBtn">Kaydet</button><button class="secondary" id="cancelBtn">Ä°ptal</button>
      </div>
    </div>
  </main>
</div>

<script type="module">
import { requireAuth } from "./guard.js";
import { listCol, addWithTS, updateById, deleteById, colProjects, colPersonnel } from "./db.js";
import { fmtDate, badgeStatus } from "./ui.js";

requireAuth();
let projects=[], personnel=[], editingId=null;

function fillProjects(){
  projectFilter.innerHTML = ['<option value="">TÃ¼m Projeler</option>'].concat(projects.map(p=>`<option value="${p.id}">${p.name}</option>`)).join("");
  projectId.innerHTML = projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join("");
}
async function load(){
  projects=await listCol(colProjects);
  personnel=await listCol(colPersonnel);
  fillProjects(); render();
}
function render(){
  const text=q.value.toLowerCase(), pf=projectFilter.value, sf=statusFilter.value;
  const filtered=personnel.filter(p=>{
    const mt=(p.fullName||"").toLowerCase().includes(text)||(p.title||"").toLowerCase().includes(text);
    const mp=!pf || p.projectId===pf;
    const ms=!sf || (p.status||"").toLowerCase()===sf;
    return mt&&mp&&ms;
  });
  tbody.innerHTML = filtered.map(p=>{
    const proj=projects.find(x=>x.id===p.projectId);
    return `<tr>
      <td><b>${p.fullName}</b></td><td>${p.title||"-"}</td><td>${proj?.name||"-"}</td>
      <td>${badgeStatus(p.status)}</td><td>${fmtDate(p.startDate)}</td>
      <td style="text-align:right;">
        <a class="badge" href="personnel_detail.html?id=${p.id}">Detay</a>
        <button class="secondary" data-edit="${p.id}">DÃ¼zenle</button>
        <button class="secondary" data-del="${p.id}">Sil</button>
      </td></tr>`;
  }).join("");
  tbody.querySelectorAll("[data-edit]").forEach(b=>b.onclick=()=>edit(b.dataset.edit));
  tbody.querySelectorAll("[data-del]").forEach(b=>b.onclick=()=>del(b.dataset.del));
}
function edit(id){
  const p=personnel.find(x=>x.id===id);
  editingId=id; formCard.style.display="block"; formTitle.textContent="Personel DÃ¼zenle";
  fullName.value=p.fullName||""; title.value=p.title||""; phone.value=p.phone||"";
  status.value=p.status||"aktif"; projectId.value=p.projectId||projects[0]?.id||"";
  startDate.value = p.startDate?.toDate ? p.startDate.toDate().toISOString().slice(0,10) : "";
}
async function del(id){ if(confirm("Personel silinsin mi?")){ await deleteById(colPersonnel,id); await load(); } }

addBtn.onclick=()=>{ editingId=null; formCard.style.display="block"; formTitle.textContent="Yeni Personel";
  fullName.value=""; title.value=""; phone.value=""; status.value="aktif"; startDate.value="";
  projectId.value=projects[0]?.id||""; };
cancelBtn.onclick=()=>formCard.style.display="none";
saveBtn.onclick=async ()=>{
  const data={fullName:fullName.value.trim(), title:title.value.trim(), phone:phone.value.trim(),
    projectId:projectId.value, status:status.value, startDate: startDate.value? new Date(startDate.value): null};
  if(!data.fullName) return alert("Ad soyad boÅŸ olamaz");
  if(editingId) await updateById(colPersonnel,editingId,data); else await addWithTS(colPersonnel,data);
  formCard.style.display="none"; await load();
};
q.oninput=render; projectFilter.onchange=render; statusFilter.onchange=render;
load();
</script>
</body></html>
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SNR VIP | Personel</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">SNR</div>
      <div>
        <div class="title">SNR VIP</div>
        <div class="sub">GÃ¼venlik & Koruma</div>
      </div>
    </div>

    <nav class="nav">
      <a href="dashboard.html">ğŸ  Dashboard</a>
      <a href="projects.html">ğŸ—ï¸ Proje Paneli</a>
      <a class="active" href="personnel.html">ğŸ‘® Personel</a>
      <a href="vehicles.html">ğŸš— AraÃ§ YÃ¶netimi</a>
      <a href="#" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ</a>
    </nav>
  </aside>

  <main class="main">
    <div class="topbar">
      <h1 style="margin:0;">Personel</h1>
      <div class="user">
        <div class="pill" id="currentUser">YÃ¶netici</div>
      </div>
    </div>

    <!-- Ã¼st toolbar -->
    <div class="toolbar">
      <input id="q" placeholder="Personel ara (ad/Ã¼nvan)"/>
      <select id="projectFilter"></select>
      <select id="statusFilter">
        <option value="">TÃ¼m Durumlar</option>
        <option value="aktif">Aktif</option>
        <option value="pasif">Pasif</option>
      </select>
      <button id="addBtn">+ Personel Ekle</button>
    </div>

    <!-- liste tablo -->
    <table>
      <thead>
      <tr>
        <th>AD SOYAD</th>
        <th>ÃœNVAN</th>
        <th>PROJE</th>
        <th>DURUM</th>
        <th>Ä°ÅE GÄ°RÄ°Å</th>
        <th>TELEFON</th>
        <th></th>
      </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <!-- form kart -->
    <div id="formCard" class="card" style="display:none;">
      <h2 id="formTitle">Yeni Personel</h2>
      <div class="toolbar">
        <input id="pName" placeholder="Ad Soyad"/>
        <select id="pTitle">
          <option value="vardiya_amiri">Vardiya Amiri</option>
          <option value="danisman">DanÄ±ÅŸman</option>
          <option value="yonetim">YÃ¶netim</option>
        </select>

        <select id="pProjectId"></select>

        <select id="pStatus">
          <option value="aktif">Aktif</option>
          <option value="pasif">Pasif</option>
        </select>

        <input id="pStartDate" type="date" />
        <input id="pPhone" placeholder="Telefon (ops.)"/>

        <button id="saveBtn">Kaydet</button>
        <button class="secondary" id="cancelBtn">Ä°ptal</button>
      </div>
    </div>

  </main>
</div>

<script type="module">
  import { requireAuth } from "./guard.js";
  import { db } from "./firebase.js";
  import {
    collection, getDocs, addDoc, updateDoc, deleteDoc, doc,
    query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  requireAuth();

  // koleksiyonlar
  const personnelRef = collection(db, "personnel");
  const projectsRef  = collection(db, "projects");

  // elementler
  const qInput        = document.getElementById("q");
  const projectFilter = document.getElementById("projectFilter");
  const statusFilter  = document.getElementById("statusFilter");
  const addBtn        = document.getElementById("addBtn");
  const tbody         = document.getElementById("tbody");

  const formCard   = document.getElementById("formCard");
  const formTitle  = document.getElementById("formTitle");
  const pName      = document.getElementById("pName");
  const pTitle     = document.getElementById("pTitle");
  const pProjectId = document.getElementById("pProjectId");
  const pStatus    = document.getElementById("pStatus");
  const pStartDate = document.getElementById("pStartDate");
  const pPhone     = document.getElementById("pPhone");
  const saveBtn    = document.getElementById("saveBtn");
  const cancelBtn  = document.getElementById("cancelBtn");

  // state
  let personnel = [];
  let projects  = [];
  let editingId = null;

  const escapeHtml = (s="") =>
    String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));

  // isim normalize: hangi key olursa olsun yakala
  function getName(p){
    return String(
      p.name ??
      p.fullName ??
      p.full_name ??
      p.fullname ??
      p.adSoyad ??
      p.ad_soyad ??
      p.ad ??
      p.isim ??
      ""
    ).trim();
  }

  function normalizeDoc(d){
    const data = d.data();
    return {
      id: d.id,
      ...data,
      name: getName(data),
      title: data.title || data.unvan || data.role || "danisman",
      status: data.status || "aktif",
      projectId: data.projectId || "",
      startDate: data.startDate || "",
      phone: data.phone || data.tel || ""
    };
  }

  function getProjectName(pid){
    const p = projects.find(x => x.id === pid);
    return p ? p.name : "-";
  }

  function titleLabel(t){
    if(t === "vardiya_amiri") return "Vardiya Amiri";
    if(t === "yonetim") return "YÃ¶netim";
    return "DanÄ±ÅŸman";
  }

  function filteredPersonnel(){
    const q = (qInput.value || "").toLowerCase().trim();
    const pf = projectFilter.value || "";
    const sf = statusFilter.value || "";

    return personnel.filter(p => {
      const name = getName(p).toLowerCase();
      const title = (p.title || "").toLowerCase();
      const matchesQ = !q || name.includes(q) || title.includes(q);
      const matchesP = !pf || p.projectId === pf;
      const matchesS = !sf || p.status === sf;
      return matchesQ && matchesP && matchesS;
    });
  }

  function render(){
    const rows = filteredPersonnel().map(p => `
      <tr>
        <td><b>${escapeHtml(getName(p) || "-")}</b></td>
        <td>${escapeHtml(titleLabel(p.title))}</td>
        <td>${escapeHtml(getProjectName(p.projectId))}</td>
        <td>${escapeHtml(p.status || "-")}</td>
        <td>${escapeHtml(p.startDate || "-")}</td>
        <td>${escapeHtml(p.phone || "-")}</td>
        <td style="white-space:nowrap;">
          <button class="btn small edit" data-id="${p.id}">DÃ¼zenle</button>
          <button class="btn small danger del" data-id="${p.id}">Sil</button>
        </td>
      </tr>
    `).join("");

    tbody.innerHTML = rows || `<tr><td colspan="7" style="opacity:.6;">KayÄ±t yok</td></tr>`;

    tbody.querySelectorAll(".edit").forEach(btn => {
      btn.onclick = () => openEdit(btn.dataset.id);
    });
    tbody.querySelectorAll(".del").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.dataset.id;
        if(confirm("Personel silinsin mi?")){
          await deleteDoc(doc(db,"personnel",id));
          await loadPersonnel();
        }
      };
    });
  }

  function openForm(){
    formCard.style.display = "block";
  }

  function closeForm(){
    formCard.style.display = "none";
    editingId = null;
    formTitle.textContent = "Yeni Personel";
    pName.value = "";
    pTitle.value = "danisman";
    pProjectId.value = "";
    pStatus.value = "aktif";
    pStartDate.value = "";
    pPhone.value = "";
  }

  function openEdit(id){
    const p = personnel.find(x => x.id === id);
    if(!p) return;

    editingId = id;
    formTitle.textContent = "Personel DÃ¼zenle";
    openForm();

    pName.value      = getName(p);
    pTitle.value     = p.title || "danisman";
    pProjectId.value = p.projectId || "";
    pStatus.value    = p.status || "aktif";
    pStartDate.value = p.startDate || "";
    pPhone.value     = p.phone || "";
  }

  saveBtn.onclick = async () => {
    const name = pName.value.trim();
    const title = pTitle.value;
    const projectId = pProjectId.value || "";
    const status = pStatus.value || "aktif";
    const startDate = pStartDate.value || "";
    const phone = pPhone.value.trim();

    if(!name){
      alert("Ad Soyad boÅŸ olamaz");
      return;
    }

    const payload = {
      name, title, projectId, status,
      startDate, phone,
      createdAt: new Date()
    };

    if(editingId){
      await updateDoc(doc(db,"personnel",editingId), payload);
    }else{
      await addDoc(personnelRef, payload);
    }

    closeForm();
    await loadPersonnel();
  };

  cancelBtn.onclick = closeForm;
  addBtn.onclick = () => {
    editingId = null;
    formTitle.textContent = "Yeni Personel";
    openForm();
  };

  async function loadProjects(){
    const snap = await getDocs(query(projectsRef, orderBy("createdAt","desc")));
    projects = snap.docs.map(d => ({id:d.id, ...d.data()}));

    const options = [
      `<option value="">TÃ¼m Projeler</option>`,
      ...projects.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`)
    ].join("");

    projectFilter.innerHTML = options;
    pProjectId.innerHTML = `<option value="">Proje SeÃ§ (ops.)</option>` + 
      projects.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");
  }

  async function loadProjects(){
  let snap;
  try {
    snap = await getDocs(query(projectsRef, orderBy("createdAt","desc")));
  } catch(e){
    // eski projelerde createdAt yoksa buraya dÃ¼ÅŸer
    console.warn("projects createdAt yok, orderBy kaldÄ±rÄ±ldÄ±");
    snap = await getDocs(projectsRef);
  }

  projects = snap.docs.map(d => ({id:d.id, ...d.data()}));

  const options = [
    `<option value="">TÃ¼m Projeler</option>`,
    ...projects.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`)
  ].join("");

  projectFilter.innerHTML = options;
  pProjectId.innerHTML =
    `<option value="">Proje SeÃ§ (ops.)</option>` +
    projects.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");
}

</script>
</body>
</html>

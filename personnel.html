<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SNR VIP | Personel</title>
  <link rel="stylesheet" href="styles.css"/>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">SNR</div>
      <div>
        <div class="title">SNR VIP</div>
        <div class="sub">GÃ¼venlik & Koruma</div>
      </div>
    </div>
    <nav class="nav">
      <a href="dashboard.html">ğŸ  Dashboard</a>
      <a href="projects.html">ğŸ—ï¸ Proje Paneli</a>
      <a class="active" href="personnel.html">ğŸ‘® Personel</a>
      <a href="vehicles.html">ğŸš— AraÃ§ YÃ¶netimi</a>
      <a href="#" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ</a>
    </nav>
  </aside>

  <main class="main">
    <div class="topbar">
      <h1 style="margin:0;">Personel</h1>
      <div class="user">
        <div class="pill" id="currentUser">YÃ¶netici</div>
      </div>
    </div>

    <div class="toolbar">
      <input id="q" placeholder="Personel ara (ad/Ã¼nvan)"/>
      <select id="projectFilter"></select>
      <select id="statusFilter">
        <option value="">TÃ¼m Durumlar</option>
        <option value="aktif">Aktif</option>
        <option value="izinli">Ä°zinli</option>
        <option value="pasif">Pasif</option>
      </select>
      <button id="addBtn">+ Personel Ekle</button>
    </div>

    <table>
      <thead>
      <tr>
        <th>AD SOYAD</th>
        <th>ÃœNVAN</th>
        <th>PROJE</th>
        <th>DURUM</th>
        <th>Ä°ÅE GÄ°RÄ°Å</th>
        <th>TELEFON</th>
        <th></th>
      </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <!-- yeni personel kartÄ± (script bunu aÃ§Ä±p kapatÄ±r) -->
    <div id="addCard" class="card" style="display:none; margin-top:14px;">
      <h2>Yeni Personel</h2>
      <div class="toolbar">
        <input id="pFullName" placeholder="Ad Soyad"/>
        
        <!-- Ãœnvan seÃ§meli -->
        <select id="pTitle">
  <option value="">Ãœnvan SeÃ§</option>
  <option value="VARDIYA AMÄ°RÄ°">VARDIYA AMÄ°RÄ°</option>
  <option value="DANIÅMAN">DANIÅMAN</option>
  <option value="YÃ–NETÄ°M">YÃ–NETÄ°M</option>
</select>


        <select id="pProjectId"></select>

        <select id="pStatus">
          <option value="aktif">Aktif</option>
          <option value="izinli">Ä°zinli</option>
          <option value="pasif">Pasif</option>
        </select>

        <input id="pStartDate" type="date" placeholder="Ä°ÅŸe GiriÅŸ"/>
        <input id="pPhone" placeholder="Telefon (ops.)"/>

        <button id="saveBtn">Kaydet</button>
        <button class="secondary" id="cancelBtn">Ä°ptal</button>
      </div>
    </div>

  </main>
</div>

<script type="module">
  import { requireAuth } from "./guard.js";
  import { db } from "./firebase.js";
  import {
    collection, getDocs, addDoc, updateDoc, deleteDoc, doc,
    query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  requireAuth();

  // Collections
  const personnelRef = collection(db, "personnel");
  const projectsRef  = collection(db, "projects");

  // ---- DOM (robust) ----
  const qInput =
    document.getElementById("q") ||
    document.querySelector('input[placeholder*="Personel ara"]');

  const projectFilter =
    document.getElementById("projectFilter") ||
    document.getElementById("pFilter") ||
    document.querySelector("select");

  const statusFilter =
    document.getElementById("statusFilter") ||
    document.getElementById("pStatusFilter") ||
    [...document.querySelectorAll("select")].find(s => s.id.toLowerCase().includes("durum"));

  const addBtn =
    document.getElementById("addBtn") ||
    document.getElementById("addPersonnelBtn") ||
    [...document.querySelectorAll("button")].find(b => b.textContent.toLowerCase().includes("personel ekle"));

  const tbody =
    document.getElementById("tbody") ||
    document.querySelector("tbody");

  // Form alanlarÄ± (edit + add aynÄ± form)
  const formCard =
    document.getElementById("formCard") ||
    [...document.querySelectorAll(".card")].find(c => c.textContent.toLowerCase().includes("personel"));

  const pName =
    document.getElementById("pName") ||
    document.getElementById("pFullName") ||
    document.getElementById("fullName") ||
    document.getElementById("adSoyad") ||
    [...document.querySelectorAll("input")].find(i => i.placeholder?.toLowerCase().includes("ad"));

  const pTitle =
    document.getElementById("pTitle") ||
    document.getElementById("title") ||
    [...document.querySelectorAll("select,input")].find(i => i.id?.toLowerCase().includes("title") || i.placeholder?.toLowerCase().includes("Ã¼nvan"));

  const pProjectId =
    document.getElementById("pProjectId") ||
    document.getElementById("projectId") ||
    [...document.querySelectorAll("select")].find(s => s.id?.toLowerCase().includes("project"));

  const pStatus =
    document.getElementById("pStatus") ||
    document.getElementById("status") ||
    [...document.querySelectorAll("select")].find(s => s.id?.toLowerCase().includes("status") || s.id?.toLowerCase().includes("durum"));

  const pStartDate =
    document.getElementById("pStartDate") ||
    document.getElementById("startDate") ||
    [...document.querySelectorAll("input")].find(i => i.type === "date" || i.placeholder?.toLowerCase().includes("gg.aa"));

  const pPhone =
    document.getElementById("pPhone") ||
    document.getElementById("phone") ||
    [...document.querySelectorAll("input")].find(i => i.placeholder?.toLowerCase().includes("telefon"));

  const saveBtn =
    document.getElementById("saveBtn") ||
    [...document.querySelectorAll("button")].find(b => b.textContent.toLowerCase().includes("kaydet"));

  const cancelBtn =
    document.getElementById("cancelBtn") ||
    [...document.querySelectorAll("button")].find(b => b.textContent.toLowerCase().includes("iptal"));

  if (!addBtn || !tbody || !formCard || !saveBtn) {
    console.error("personnel: gerekli elementler bulunamadÄ±");
    throw new Error("personnel html ids uyumsuz");
  }

  // ---- State ----
  let personnel = [];
  let projects = [];
  let editingId = null;

  const TITLES = [
    { value: "vardiya_amiri", label: "Vardiya Amiri" },
    { value: "danisman",      label: "DanÄ±ÅŸman" },
    { value: "yonetim",       label: "YÃ¶netim" }
  ];

  const escapeHtml = (s="") =>
    s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function getName(p){
    return (p.name || p.fullName || p.adSoyad || p.ad || "").trim();
  }

  function getProjectName(pid){
    if(!pid) return "-";
    const pr = projects.find(x => x.id === pid);
    return pr ? pr.name : "-";
  }

  function normalizeDoc(d){
    const data = d.data();
    return {
      id: d.id,
      ...data,
      // isim alanÄ±nÄ± garantiye al
      name: (data.name || data.fullName || data.adSoyad || "").trim()
    };
  }

  function setFormVisible(v){
    formCard.style.display = v ? "block" : "none";
  }

  function clearForm(){
    if(pName) pName.value = "";
    if(pPhone) pPhone.value = "";
    if(pStartDate) pStartDate.value = "";
    if(pStatus) pStatus.value = "aktif";
    if(pProjectId) pProjectId.value = "";
    if(pTitle){
      // Ã¼nvan select ise ilk seÃ§eneÄŸe Ã§ek
      if(pTitle.tagName === "SELECT") pTitle.value = TITLES[0].value;
      else pTitle.value = "";
    }
    editingId = null;
  }

  function filteredPersonnel(){
    const q = (qInput?.value || "").toLowerCase().trim();
    const pf = projectFilter?.value || "";
    const sf = statusFilter?.value || "";

    return personnel.filter(p => {
      const name = getName(p).toLowerCase();
      const title = (p.title || "").toLowerCase();
      const matchesQ = !q || name.includes(q) || title.includes(q);
      const matchesP = !pf || p.projectId === pf;
      const matchesS = !sf || p.status === sf;
      return matchesQ && matchesP && matchesS;
    });
  }

  function render(){
    const rows = filteredPersonnel().map(p => {
      return `
        <tr>
          <td><b>${escapeHtml(getName(p) || "-")}</b></td>
          <td>${escapeHtml(p.titleLabel || p.title || "-")}</td>
          <td>${escapeHtml(getProjectName(p.projectId))}</td>
          <td>${escapeHtml(p.status || "-")}</td>
          <td>${escapeHtml(p.startDate || "-")}</td>
          <td>${escapeHtml(p.phone || "-")}</td>
          <td class="actions">
            <button class="btn small edit" data-id="${p.id}">DÃ¼zenle</button>
            <button class="btn small danger del" data-id="${p.id}">Sil</button>
          </td>
        </tr>
      `;
    }).join("");

    tbody.innerHTML = rows;

    tbody.querySelectorAll(".del").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.dataset.id;
        if(confirm("Personeli silmek istiyor musun?")){
          await deleteDoc(doc(db, "personnel", id));
          await loadPersonnel();
        }
      };
    });

    tbody.querySelectorAll(".edit").forEach(btn => {
      btn.onclick = () => openEdit(btn.dataset.id);
    });
  }

  function openEdit(id){
    const p = personnel.find(x => x.id === id);
    if(!p) return;
    editingId = id;

    setFormVisible(true);

    if(pName) pName.value = getName(p);
    if(pPhone) pPhone.value = p.phone || "";
    if(pStartDate) pStartDate.value = p.startDate || "";
    if(pStatus) pStatus.value = p.status || "aktif";
    if(pProjectId) pProjectId.value = p.projectId || "";
    if(pTitle){
      if(pTitle.tagName === "SELECT") pTitle.value = p.title || TITLES[0].value;
      else pTitle.value = p.title || "";
    }
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  async function save(){
    const name = (pName?.value || "").trim();
    const title = (pTitle?.value || TITLES[0].value);
    const projectId = (pProjectId?.value || "");
    const status = (pStatus?.value || "aktif");
    const startDate = (pStartDate?.value || "");
    const phone = (pPhone?.value || "");

    if(!name){
      alert("Ad Soyad boÅŸ olamaz");
      return;
    }

    const payload = {
      // iki alanÄ± da yazÄ±yoruz (eski scriptler bozulmasÄ±n)
      name,
      fullName: name,
      title,
      titleLabel: TITLES.find(t=>t.value===title)?.label || title,
      projectId,
      status,
      startDate,
      phone,
      createdAt: new Date()
    };

    if(editingId){
      await updateDoc(doc(db,"personnel",editingId), payload);
    }else{
      await addDoc(personnelRef, payload);
    }

    clearForm();
    setFormVisible(false);
    await loadPersonnel();
  }

  // ---- Loaders ----
  async function loadProjects(){
    const snap = await getDocs(query(projectsRef, orderBy("createdAt","desc")));
    projects = snap.docs.map(d => ({ id:d.id, ...d.data() }));

    const options = `
      <option value="">TÃ¼m Projeler</option>
      ${projects.map(p=>`<option value="${p.id}">${escapeHtml(p.name||"-")}</option>`).join("")}
    `;

    if(projectFilter) projectFilter.innerHTML = options;
    if(pProjectId) pProjectId.innerHTML = `<option value="">-</option>` + projects.map(p=>`<option value="${p.id}">${escapeHtml(p.name||"-")}</option>`).join("");
  }

  async function loadPersonnel(){
    const snap = await getDocs(query(personnelRef, orderBy("createdAt","desc")));
    personnel = snap.docs.map(normalizeDoc);
    render();
  }

  function initTitleSelect(){
    if(pTitle && pTitle.tagName === "SELECT"){
      pTitle.innerHTML = TITLES.map(t=>`<option value="${t.value}">${t.label}</option>`).join("");
    }
  }

  // ---- Events ----
  addBtn.onclick = () => {
    clearForm();
    initTitleSelect();
    setFormVisible(true);
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  saveBtn.onclick = save;
  cancelBtn?.onclick = () => { clearForm(); setFormVisible(false); };

  qInput?.addEventListener("input", render);
  projectFilter?.addEventListener("change", render);
  statusFilter?.addEventListener("change", render);

  // ---- Start ----
  window.addEventListener("DOMContentLoaded", async () => {
    initTitleSelect();
    await loadProjects();
    await loadPersonnel();
    setFormVisible(false);
  });
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SNR VIP | YÃ¶netim Paneli</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">SNR</div>
      <div>
        <div class="title">SNR VIP</div>
        <div class="sub">GÃ¼venlik & Koruma</div>
      </div>
    </div>

    <nav class="nav">
      <a class="active" href="dashboard.html">ğŸ  Dashboard</a>
      <a href="projects.html">ğŸ—ï¸ Proje Paneli</a>
      <a href="personnel.html">ğŸ‘® Personel</a>
      <a href="vehicles.html">ğŸš— AraÃ§ YÃ¶netimi</a>
      <a href="#" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ</a>
    </nav>
  </aside>

  <main class="main">
    <div class="topbar">
      <h1 style="margin:0;">Dashboard</h1>
      <div class="user">
        <div class="pill" id="currentUser">YÃ¶netici</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="icon">ğŸ“Œ</div>
        <h3>Projeler</h3>
        <div class="big" id="statProjects">0</div>
      </div>
      <div class="card">
        <div class="icon">ğŸ‘¥</div>
        <h3>Personel</h3>
        <div class="big" id="statPersonnel">0</div>
      </div>
      <div class="card">
        <div class="icon">ğŸš™</div>
        <h3>AraÃ§</h3>
        <div class="big" id="statVehicles">0</div>
      </div>
      <div class="card">
        <div class="icon">âš ï¸</div>
        <h3>Son 30 GÃ¼nde Olay</h3>
        <div class="big" id="statEvents">0</div>
      </div>
    </div>

    <div class="section">
      <h2>Son Tutanaklar</h2>
      <div id="recentDisciplinary" class="list"></div>
    </div>

    <div class="section">
      <h2>Servisteki AraÃ§lar</h2>
      <div id="serviceVehicles" class="list"></div>
    </div>

  </main>
</div>

<script type="module">
  import { requireAuth } from "./guard.js";
  import { listCol, colProjects, colPersonnel, colVehicles } from "./db.js";
  import { fmtDate, badgeStatus } from "./ui.js";
  import { db } from "./firebase.js";
  import {
    collection, query, where, orderBy, limit, getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  requireAuth();

  async function loadStats(){
    const [projects, personnel, vehicles] = await Promise.all([
      listCol(colProjects),
      listCol(colPersonnel),
      listCol(colVehicles)
    ]);

    document.getElementById("statProjects").textContent = projects.length;
    document.getElementById("statPersonnel").textContent = personnel.length;
    document.getElementById("statVehicles").textContent = vehicles.length;

    const since = new Date();
    since.setDate(since.getDate() - 30);

    const evSnap = await getDocs(
      query(collection(db,"personnel_events"), where("date",">=",since))
    );
    document.getElementById("statEvents").textContent = evSnap.size;

    // recent tutanaklar
    const dSnap = await getDocs(
      query(collection(db,"personnel_events"),
        where("type","==","tutanak"),
        orderBy("date","desc"),
        limit(10)
      )
    );
    const dItems = dSnap.docs.map(d=>({id:d.id,...d.data()}));
    const container = document.getElementById("recentDisciplinary");
    container.innerHTML = dItems.length ? dItems.map(e=>`
      <div class="list-item">
        <div>
          <div><b>${e.reason || "Tutanak"}</b></div>
          <div class="meta">${fmtDate(e.date)} â€¢ ${e.description||""}</div>
        </div>
        <div class="badge red">Tutanak</div>
      </div>
    `).join("") : `<div class="card">HenÃ¼z tutanak yok.</div>`;

    // serviste araÃ§lar
    const serv = vehicles.filter(v => (v.status||"").toLowerCase()==="serviste");
    const svc = document.getElementById("serviceVehicles");
    svc.innerHTML = serv.length ? serv.map(v=>`
      <div class="list-item">
        <div>
          <div><b>${v.plate}</b> â€¢ ${v.brandModel||""}</div>
          <div class="meta">KM: ${v.km||"-"}</div>
        </div>
        ${badgeStatus(v.status)}
      </div>
    `).join("") : `<div class="card">Serviste araÃ§ yok.</div>`;
  }

  loadStats();
</script>
</body>
</html>

<!DOCTYPE html><html lang="tr"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SNR VIP | AraÃ§lar</title><link rel="stylesheet" href="styles.css"/></head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand"><div class="logo">SNR</div><div><div class="title">SNR VIP</div><div class="sub">GÃ¼venlik & Koruma</div></div></div>
    <nav class="nav">
      <a href="dashboard.html">ğŸ  Dashboard</a><a href="projects.html">ğŸ—ï¸ Proje Paneli</a>
      <a href="personnel.html">ğŸ‘® Personel</a><a class="active" href="vehicles.html">ğŸš— AraÃ§ YÃ¶netimi</a>
      <a href="#" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ</a>
    </nav>
  </aside>
  <main class="main">
    <div class="topbar"><h1 style="margin:0;">AraÃ§lar</h1><div class="user"><div class="pill" id="currentUser">YÃ¶netici</div></div></div>
    <div class="toolbar">
      <input id="q" placeholder="AraÃ§ ara (plaka/model)"/>
      <select id="projectFilter"></select>
      <select id="statusFilter"><option value="">TÃ¼m Durumlar</option><option value="aktif">Aktif</option><option value="serviste">Serviste</option><option value="pasif">Pasif</option></select>
      <button id="addBtn">+ AraÃ§ Ekle</button>
    </div>
    <table><thead><tr><th>Plaka</th><th>Model</th><th>Proje</th><th>Durum</th><th>KM</th><th></th></tr></thead>
      <tbody id="tbody"></tbody></table>

    <div id="formCard" class="card" style="display:none;">
      <h2 id="formTitle">Yeni AraÃ§</h2>
      <div class="toolbar">
        <input id="plate" placeholder="Plaka"/><input id="brandModel" placeholder="Marka/Model"/>
        <select id="projectId"></select>
        <select id="status"><option value="aktif">Aktif</option><option value="serviste">Serviste</option><option value="pasif">Pasif</option></select>
        <input id="km" type="number" placeholder="KM"/>
        <button id="saveBtn">Kaydet</button><button class="secondary" id="cancelBtn">Ä°ptal</button>
      </div>
    </div>
  </main>
</div>

<script type="module">
  import { requireAuth } from "./guard.js";
  import { db } from "./firebase.js";
  import {
    collection, getDocs, addDoc, updateDoc, deleteDoc, doc,
    query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  requireAuth();

  const colRef = collection(db, "vehicles");

  // âœ… BUTON ve LÄ°STEYÄ° ID yerine daha saÄŸlam ÅŸekilde buluyoruz
  const addBtn =
    document.getElementById("addBtn") ||
    document.getElementById("addVehicleBtn") ||
    document.querySelector("button.primary") ||
    [...document.querySelectorAll("button")].find(b => b.textContent.toLowerCase().includes("araÃ§ ekle"));

  const listEl =
    document.getElementById("vehiclesList") ||
    document.getElementById("list") ||
    document.getElementById("vehicleList") ||
    document.querySelector(".list");

  if (!addBtn || !listEl) {
    console.error("vehicles: addBtn veya liste alanÄ± bulunamadÄ±. HTML'de buton/list isimleri farklÄ±.");
    throw new Error("vehicles addBtn/list missing");
  }

  let vehicles = [];
  let addRowOpen = false;

  const escapeHtml = (s="") =>
    s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function rowTemplate(v){
    return `
      <div class="row">
        <div class="cell"><b>${escapeHtml(v.plate)}</b></div>
        <div class="cell">${escapeHtml(v.brand || "-")}</div>
        <div class="cell">${escapeHtml(v.projectName || "-")}</div>
        <div class="cell">${escapeHtml(v.status || "-")}</div>
        <div class="cell actions">
          <button class="btn small edit" data-id="${v.id}">DÃ¼zenle</button>
          <button class="btn small danger del" data-id="${v.id}">Sil</button>
        </div>
      </div>
    `;
  }

  function addRowTemplate(){
    return `
      <div class="row new-row">
        <div class="cell"><input id="vPlate" placeholder="Plaka" /></div>
        <div class="cell"><input id="vBrand" placeholder="Marka / Model" /></div>
        <div class="cell"><input id="vProject" placeholder="BaÄŸlÄ± Proje (ops.)" /></div>
        <div class="cell">
          <select id="vStatus">
            <option value="aktif">Aktif</option>
            <option value="serviste">Serviste</option>
            <option value="pasif">Pasif</option>
          </select>
        </div>
        <div class="cell actions">
          <button class="btn small primary" id="saveBtn">Kaydet</button>
          <button class="btn small" id="cancelBtn">Ä°ptal</button>
        </div>
      </div>
    `;
  }

  function render(){
    listEl.innerHTML = `
      ${addRowOpen ? addRowTemplate() : ""}
      ${vehicles.map(rowTemplate).join("")}
    `;

    if(addRowOpen){
      document.getElementById("saveBtn").onclick = saveNew;
      document.getElementById("cancelBtn").onclick = closeAddRow;
    }

    listEl.querySelectorAll(".del").forEach(btn=>{
      btn.onclick = async ()=>{
        const id = btn.dataset.id;
        if(confirm("AracÄ± silmek istiyor musun?")){
          await deleteDoc(doc(db,"vehicles",id));
          await load();
        }
      };
    });

    listEl.querySelectorAll(".edit").forEach(btn=>{
      btn.onclick = ()=> openEdit(btn.dataset.id);
    });
  }

  function openAddRow(){ addRowOpen = true; render(); }
  function closeAddRow(){ addRowOpen = false; render(); }

  async function saveNew(){
    const plate = (document.getElementById("vPlate")?.value || "").trim();
    const brand = (document.getElementById("vBrand")?.value || "").trim();
    const projectName = (document.getElementById("vProject")?.value || "").trim();
    const status = document.getElementById("vStatus")?.value || "aktif";

    if(!plate){ alert("Plaka boÅŸ olamaz"); return; }

    await addDoc(colRef, {
      plate, brand, projectName, status,
      createdAt: new Date()
    });

    addRowOpen = false;
    await load();
  }

  function openEdit(id){
    const v = vehicles.find(x=>x.id===id);
    if(!v) return;

    addRowOpen = false;
    listEl.innerHTML = `
      <div class="row new-row">
        <div class="cell"><input id="ePlate" value="${escapeHtml(v.plate)}"/></div>
        <div class="cell"><input id="eBrand" value="${escapeHtml(v.brand||"")}"/></div>
        <div class="cell"><input id="eProject" value="${escapeHtml(v.projectName||"")}"/></div>
        <div class="cell">
          <select id="eStatus">
            <option value="aktif" ${v.status==="aktif"?"selected":""}>Aktif</option>
            <option value="serviste" ${v.status==="serviste"?"selected":""}>Serviste</option>
            <option value="pasif" ${v.status==="pasif"?"selected":""}>Pasif</option>
          </select>
        </div>
        <div class="cell actions">
          <button class="btn small primary" id="updateBtn">GÃ¼ncelle</button>
          <button class="btn small" id="cancelEditBtn">Ä°ptal</button>
        </div>
      </div>
      ${vehicles.filter(x=>x.id!==id).map(rowTemplate).join("")}
    `;

    document.getElementById("updateBtn").onclick = async ()=>{
      const plate = document.getElementById("ePlate").value.trim();
      const brand = document.getElementById("eBrand").value.trim();
      const projectName = document.getElementById("eProject").value.trim();
      const status = document.getElementById("eStatus").value;
      if(!plate){ alert("Plaka boÅŸ olamaz"); return; }

      await updateDoc(doc(db,"vehicles",id), { plate, brand, projectName, status });
      await load();
    };

    document.getElementById("cancelEditBtn").onclick = render;
  }

  async function load(){
    const snap = await getDocs(query(colRef, orderBy("createdAt","desc")));
    vehicles = snap.docs.map(d=>({id:d.id, ...d.data()}));
    render();
  }

  // âœ… DOM hazÄ±r olunca baÄŸla
  window.addEventListener("DOMContentLoaded", () => {
    addBtn.onclick = openAddRow;
    load();
  });
</script>

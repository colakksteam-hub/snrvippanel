<!DOCTYPE html><html lang="tr"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SNR VIP | AraÃ§lar</title><link rel="stylesheet" href="styles.css"/></head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand"><div class="logo">SNR</div><div><div class="title">SNR VIP</div><div class="sub">GÃ¼venlik & Koruma</div></div></div>
    <nav class="nav">
      <a href="dashboard.html">ğŸ  Dashboard</a><a href="projects.html">ğŸ—ï¸ Proje Paneli</a>
      <a href="personnel.html">ğŸ‘® Personel</a><a class="active" href="vehicles.html">ğŸš— AraÃ§ YÃ¶netimi</a>
      <a href="#" onclick="logout()">ğŸšª Ã‡Ä±kÄ±ÅŸ</a>
    </nav>
  </aside>
  <main class="main">
    <div class="topbar"><h1 style="margin:0;">AraÃ§lar</h1><div class="user"><div class="pill" id="currentUser">YÃ¶netici</div></div></div>
    <div class="toolbar">
      <input id="q" placeholder="AraÃ§ ara (plaka/model)"/>
      <select id="projectFilter"></select>
      <select id="statusFilter"><option value="">TÃ¼m Durumlar</option><option value="aktif">Aktif</option><option value="serviste">Serviste</option><option value="pasif">Pasif</option></select>
      <button id="addBtn">+ AraÃ§ Ekle</button>
    </div>
    <table><thead><tr><th>Plaka</th><th>Model</th><th>Proje</th><th>Durum</th><th>KM</th><th></th></tr></thead>
      <tbody id="tbody"></tbody></table>

    <div id="formCard" class="card" style="display:none;">
      <h2 id="formTitle">Yeni AraÃ§</h2>
      <div class="toolbar">
        <input id="plate" placeholder="Plaka"/><input id="brandModel" placeholder="Marka/Model"/>
        <select id="projectId"></select>
        <select id="status"><option value="aktif">Aktif</option><option value="serviste">Serviste</option><option value="pasif">Pasif</option></select>
        <input id="km" type="number" placeholder="KM"/>
        <button id="saveBtn">Kaydet</button><button class="secondary" id="cancelBtn">Ä°ptal</button>
      </div>
    </div>
  </main>
</div>

<script type="module">
  import { requireAuth } from "./guard.js";
  import { db } from "./firebase.js";
  import {
    collection, getDocs, addDoc, updateDoc, deleteDoc, doc,
    query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  requireAuth();

  // Koleksiyonlar
  const vehiclesRef = collection(db, "vehicles");
  const projectsRef = collection(db, "projects");

  // UI elemanlarÄ±
  const qInput = document.getElementById("q");
  const projectFilter = document.getElementById("projectFilter");
  const statusFilter = document.getElementById("statusFilter");
  const addBtn = document.getElementById("addBtn");
  const tbody = document.getElementById("tbody");

  const formCard = document.getElementById("formCard");
  const formTitle = document.getElementById("formTitle");
  const plateEl = document.getElementById("plate");
  const brandModelEl = document.getElementById("brandModel");
  const projectIdEl = document.getElementById("projectId");
  const statusEl = document.getElementById("status");
  const kmEl = document.getElementById("km");
  const saveBtn = document.getElementById("saveBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  // State
  let vehicles = [];
  let projects = [];
  let editingId = null;

  // yardÄ±mcÄ±
  const escapeHtml = (s="") =>
    s.replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));

  function getProjectNameById(pid){
    const p = projects.find(x => x.id === pid);
    return p ? p.name : "-";
  }

  // --- Projeleri yÃ¼kle ve dropdownlarÄ± doldur ---
  async function loadProjects(){
    const snap = await getDocs(query(projectsRef, orderBy("createdAt","desc")));
    projects = snap.docs.map(d => {
      const data = d.data();
      return {
        id: d.id,
        // projelerde alan adÄ± ne olursa olsun yakalÄ±yoruz:
        name: data.name || data.projectName || data.title || "Ä°simsiz Proje"
      };
    });

    // form iÃ§indeki proje dropdown
    projectIdEl.innerHTML = `
      <option value="">BaÄŸlÄ± Proje (ops.)</option>
      ${projects.map(p => `
        <option value="${p.id}">${escapeHtml(p.name)}</option>
      `).join("")}
    `;

    // filtre dropdown
    projectFilter.innerHTML = `
      <option value="">TÃ¼m Projeler</option>
      ${projects.map(p => `
        <option value="${p.id}">${escapeHtml(p.name)}</option>
      `).join("")}
    `;
  }

  // --- AraÃ§larÄ± yÃ¼kle ---
  async function loadVehicles(){
    const snap = await getDocs(query(vehiclesRef, orderBy("createdAt","desc")));
    vehicles = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    render();
  }

  // --- Filtreleme ---
  function filteredVehicles(){
    const q = (qInput.value || "").toLowerCase().trim();
    const pFilter = projectFilter.value || "";
    const sFilter = statusFilter.value || "";

    return vehicles.filter(v => {
      const matchesQ =
        !q ||
        (v.plate || "").toLowerCase().includes(q) ||
        (v.brandModel || v.brand || "").toLowerCase().includes(q);

      const matchesProject =
        !pFilter || v.projectId === pFilter;

      const matchesStatus =
        !sFilter || v.status === sFilter;

      return matchesQ && matchesProject && matchesStatus;
    });
  }

  // --- Tablo render ---
  function render(){
    const items = filteredVehicles();

    tbody.innerHTML = items.map(v => `
      <tr>
        <td><b>${escapeHtml(v.plate || "")}</b></td>
        <td>${escapeHtml(v.brandModel || v.brand || "-")}</td>
        <td>${escapeHtml(getProjectNameById(v.projectId))}</td>
        <td>${escapeHtml(v.status || "-")}</td>
        <td>${escapeHtml(String(v.km ?? "-"))}</td>
        <td>
          <button class="btn small edit" data-id="${v.id}">DÃ¼zenle</button>
          <button class="btn small danger del" data-id="${v.id}">Sil</button>
        </td>
      </tr>
    `).join("");

    // sil
    tbody.querySelectorAll(".del").forEach(btn => {
      btn.onclick = async () => {
        const id = btn.dataset.id;
        if(confirm("AracÄ± silmek istiyor musun?")){
          await deleteDoc(doc(db, "vehicles", id));
          await loadVehicles();
        }
      };
    });

    // dÃ¼zenle
    tbody.querySelectorAll(".edit").forEach(btn => {
      btn.onclick = () => openEdit(btn.dataset.id);
    });
  }

  // --- Formu aÃ§/kapat ---
  function openNew(){
    editingId = null;
    formTitle.textContent = "Yeni AraÃ§";
    plateEl.value = "";
    brandModelEl.value = "";
    projectIdEl.value = "";
    statusEl.value = "aktif";
    kmEl.value = "";
    formCard.style.display = "block";
  }

  function openEdit(id){
    const v = vehicles.find(x => x.id === id);
    if(!v) return;

    editingId = id;
    formTitle.textContent = "AraÃ§ DÃ¼zenle";
    plateEl.value = v.plate || "";
    brandModelEl.value = v.brandModel || v.brand || "";
    projectIdEl.value = v.projectId || "";
    statusEl.value = v.status || "aktif";
    kmEl.value = v.km ?? "";
    formCard.style.display = "block";
  }

  function closeForm(){
    formCard.style.display = "none";
  }

  // --- Kaydet ---
  async function saveVehicle(){
    const plate = plateEl.value.trim();
    const brandModel = brandModelEl.value.trim();
    const projectId = projectIdEl.value || "";
    const status = statusEl.value || "aktif";
    const km = kmEl.value ? Number(kmEl.value) : 0;

    if(!plate){
      alert("Plaka boÅŸ olamaz"); 
      return;
    }

    const payload = {
      plate,
      brandModel,
      projectId,
      status,
      km,
      createdAt: new Date()
    };

    if(editingId){
      await updateDoc(doc(db,"vehicles", editingId), payload);
    } else {
      await addDoc(vehiclesRef, payload);
    }

    closeForm();
    await loadVehicles();
  }

  // --- Eventler ---
  window.addEventListener("DOMContentLoaded", async () => {
    addBtn.onclick = openNew;
    cancelBtn.onclick = closeForm;
    saveBtn.onclick = saveVehicle;

    qInput.oninput = render;
    projectFilter.onchange = render;
    statusFilter.onchange = render;

    await loadProjects();
    await loadVehicles();
  });

</script>
